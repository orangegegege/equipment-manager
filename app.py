import streamlit as st
import pandas as pd
from supabase import create_client, Client
from datetime import datetime
import time

# ==========================================
# ğŸ¨ [è‰²å½©èˆ‡åŸºæœ¬è¨­å®š]
# ==========================================
NAV_HEIGHT = "80px"
NAV_BG_COLOR = "#E88B00"       # ä½ çš„æ©˜è‰²
PAGE_BG_COLOR = "#F5F5F5"      # æ·ºç°åº•
LOGO_URL = "https://obmikwclquacitrwzdfc.supabase.co/storage/v1/object/public/logos/logo.png" # ä½ çš„ Logo

# ğŸ”¥ çµ±ä¸€ç®¡ç†çš„åˆ†é¡æ¸…å–®
CATEGORY_OPTIONS = ["æ‰‹å·¥å…·", "ä¸€èˆ¬å™¨æ", "å»šå…·", "æ¸…æ½”ç”¨å“", "æ–‡å…·ç”¨å“", "å…¶ä»–"]

# --- 1. Supabase é€£ç·š ---
@st.cache_resource
def init_connection():
    try:
        url = st.secrets["SUPABASE"]["URL"]
        key = st.secrets["SUPABASE"]["KEY"]
        return create_client(url, key)
    except Exception as e:
        st.error(f"Supabase é€£ç·šå¤±æ•—: {e}")
        return None

supabase: Client = init_connection()

# --- 2. åœ–ç‰‡ä¸Šå‚³ ---
def upload_image(file):
    if not file: return None
    try:
        bucket_name = st.secrets["SUPABASE"]["BUCKET"]
        file_ext = file.name.split('.')[-1]
        file_name = f"{int(time.time())}_{file.name}"
        supabase.storage.from_(bucket_name).upload(file_name, file.getvalue(), file_options={"content-type": file.type})
        return supabase.storage.from_(bucket_name).get_public_url(file_name)
    except Exception as e:
        st.error(f"ä¸Šå‚³å¤±æ•—: {e}")
        return None

# --- 3. è³‡æ–™åº« CRUD ---
def load_data():
    response = supabase.table("equipment").select("*").order("id", desc=True).execute()
    return pd.DataFrame(response.data)

def add_equipment_to_db(data):
    supabase.table("equipment").insert(data).execute()

def update_equipment_in_db(uid, updates):
    supabase.table("equipment").update(updates).eq("uid", uid).execute()

def delete_equipment_from_db(uid):
    supabase.table("equipment").delete().eq("uid", uid).execute()

# --- é é¢è¨­å®š ---
st.set_page_config(page_title="å™¨æç®¡ç†ç³»çµ±", layout="wide", page_icon="ğŸ“¦
